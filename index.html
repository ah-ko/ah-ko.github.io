<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://www.torrentwater.com/wp-content/uploads/2024/10/cropped-TorrentWater_Swirl_200dpi-32x32.png" sizes="32x32">
    <title>Torrent Water Raspi Controller</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#3891a1',
                        'custom-dark-grey': '#58595b',
                        'custom-orange': '#f68633',
                        'custom-light-grey': '#b1b3b6',
                        'custom-canada-red': '#EF3340',
                    }
                }
            }
        }
    </script>
    <style>
        .screen { display: none; }
        .screen.active { display: block; }
    </style>
</head>

<body class="bg-gray-100 text-custom-dark-grey font-sans">

    <header class="bg-custom-dark-grey text-white shadow-md">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-2xl font-bold">Raspberry Pi Web Controller</h1>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">

        <div id="device-screen" class="screen active">
            <div class="max-w-xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Connect to a Device</h2>
                <p class="text-gray-600 mb-6">Enter the local hostname or IP (e.g., api.local).</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="device-hostname" placeholder="api.local" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue">
                    <button onclick="connectToDevice()" class="bg-custom-blue text-white font-bold py-2 px-6 rounded-md hover:bg-opacity-80 transition duration-300">Connect</button>
                </div>
                <div id="device-list" class="mt-8">
                    </div>
            </div>
        </div>

        <div id="login-screen" class="screen">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h2 id="login-header" class="text-2xl font-semibold mb-6 text-center">Login to Device</h2>
                <div class="space-y-4">
                    <input type="text" id="username" placeholder="Username" value="admin" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue">
                    <input type="password" id="password" placeholder="Password" value="adminpassword" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue">
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-2">
                    <button onclick="handleLogin()" class="w-full bg-custom-blue text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Login</button>
                    <button onclick="showScreen('device-screen')" class="w-full bg-custom-light-grey text-custom-dark-grey font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Back</button>
                </div>
                 <div id="login-error" class="mt-4 text-red-600 text-sm"></div>
            </div>
        </div>

        <div id="control-panel-screen" class="screen">
            <div class="flex justify-between items-center mb-6">
                <h2 id="control-panel-header" class="text-3xl font-bold">Control Panel</h2>
                <button onclick="disconnectFromDevice()" class="bg-custom-canada-red text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Disconnect</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4">REST API</h3>
                    <button onclick="sendRestCommand()" class="bg-custom-blue text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300 mb-4">Get System Status</button>
                    <pre id="rest-log" class="w-full h-32 bg-gray-50 border border-gray-200 rounded-md p-2 overflow-y-auto font-mono text-sm"></pre>
                </div>

                <div id="ws-controls" class="lg:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6">
                    </div>
            </div>
        </div>
    </main>

<script>
    // --- State Management ---
    const knownDevices = JSON.parse(localStorage.getItem('knownDevices')) || [];
    let state = {
        currentScreen: 'device-screen',
        currentDevice: null, // e.g., "api.local"
        authToken: null,
        socket: null // Single Socket.IO instance
    };

    // --- Utility Functions ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        state.currentScreen = screenId;
        // Clear login error when switching screens
        const loginErrorDiv = document.getElementById('login-error');
        if (loginErrorDiv) loginErrorDiv.textContent = '';
    }

    function logTo(elementId, message) {
        const el = document.getElementById(elementId);
        if (el) {
            // Limit log length to prevent browser slowdown
            const maxLogLength = 2000;
            let currentLog = `[${new Date().toLocaleTimeString()}] ${message}\n` + el.textContent;
            if (currentLog.length > maxLogLength) {
                currentLog = currentLog.substring(0, maxLogLength) + '... (log truncated)';
            }
            el.textContent = currentLog;
        } else {
            console.warn(`Log element not found: ${elementId}`);
        }
    }

    // --- Device Connection & Disconnection ---
    function connectToDevice() {
        const hostnameInput = document.getElementById('device-hostname');
        const hostname = hostnameInput.value.trim();
        if (!hostname) {
            alert('Please enter a hostname or IP address.');
            return;
        }
        state.currentDevice = hostname;
        document.getElementById('login-header').textContent = `Login to ${hostname}`;
        // Attempt to retrieve stored token for this device
        state.authToken = localStorage.getItem(`authToken_${state.currentDevice}`);
        if (state.authToken) {
            console.log(`Found stored token for ${hostname}. Trying to connect directly.`);
            // If token exists, try going directly to control panel & connect socket
            setupControlPanel();
            showScreen('control-panel-screen');
            // connectSocketIO(); // connectSocketIO is now called within setupControlPanel
        } else {
            console.log(`No token found for ${hostname}. Showing login screen.`);
            showScreen('login-screen');
        }
    }

    function disconnectFromDevice() {
        disconnectSocketIO(); // Disconnect socket first
        const device = state.currentDevice; // Get device before clearing
        state.currentDevice = null;
        state.authToken = null;
        if (device) {
            localStorage.removeItem(`authToken_${device}`); // Use stored device name
        }
        showScreen('device-screen');
        populateDeviceList(); // Refresh list potentially
    }

    // --- Authentication ---
    async function handleLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const loginErrorDiv = document.getElementById('login-error');
        loginErrorDiv.textContent = ''; // Clear previous errors

        if (!state.currentDevice) {
             loginErrorDiv.textContent = 'Error: No device selected.';
             return;
        }

        try {
            logTo('rest-log', `Attempting login to https://${state.currentDevice}/auth/token...`);
            const response = await fetch(`https://${state.currentDevice}/auth/token`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (!response.ok) {
                 let errorMsg = `Login failed: ${response.status} ${response.statusText}`;
                 try { // Try to get more detail from response body
                     const errData = await response.json();
                     if (errData.detail) errorMsg += ` - ${errData.detail}`;
                 } catch (e) {/* Ignore if body isn't JSON */}
                 throw new Error(errorMsg);
             }

            const data = await response.json();
            if (!data.token) {
                 throw new Error('Login failed: Token not received from server.');
            }
            state.authToken = data.token;
            localStorage.setItem(`authToken_${state.currentDevice}`, state.authToken); // Store token associated with device
             logTo('rest-log', 'Login successful. Token received.');

            // Add device to known list if new
            if (!knownDevices.includes(state.currentDevice)) {
                knownDevices.push(state.currentDevice);
                localStorage.setItem('knownDevices', JSON.stringify(knownDevices));
                populateDeviceList(); // Update list display
            }

            setupControlPanel();
            showScreen('control-panel-screen');
        } catch (error) {
            console.error('Login error:', error);
            logTo('rest-log', `Login Error: ${error.message}`);
             loginErrorDiv.textContent = `Login Error: ${error.message}. Check console for details.`;
            // alert(error.message); // Replaced with div message
        }
    }

    // --- Control Panel Setup ---
    function setupControlPanel() {
        document.getElementById('control-panel-header').textContent = `Control Panel for ${state.currentDevice}`;
        const wsControls = document.getElementById('ws-controls');
        // Simplified UI for ONE connection, THREE logs
        wsControls.innerHTML = `
            <div class="ws-section bg-white p-6 rounded-lg shadow-md md:col-span-1">
                <h3 class="text-xl font-semibold mb-4">Socket.IO Log & Commands</h3>
                 <div class="flex gap-2 mb-4">
                     <button onclick="connectSocketIO()" class="flex-1 bg-custom-blue text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Connect</button>
                     <button onclick="disconnectSocketIO()" class="flex-1 bg-custom-light-grey text-custom-dark-grey font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Disconnect</button>
                 </div>
                 <div id="ws1-commands" style="display:none;" class="space-y-2 mb-4">
                     <button onclick="ws1_spget()" class="w-full bg-gray-200 text-custom-dark-grey font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition">Send 'spget'</button>
                     <button onclick="ws1_spset()" class="w-full bg-gray-200 text-custom-dark-grey font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition">Send 'spset'</button>
                 </div>
                 <pre id="ws1-log" class="w-full h-48 bg-gray-50 border border-gray-200 rounded-md p-2 overflow-y-auto font-mono text-sm"></pre>
             </div>
             <div class="ws-section bg-white p-6 rounded-lg shadow-md md:col-span-1">
                 <h3 class="text-xl font-semibold mb-4">State Broadcast Log (WS2)</h3>
                 <pre id="ws2-log" class="w-full h-48 bg-gray-50 border border-gray-200 rounded-md p-2 overflow-y-auto font-mono text-sm"></pre>
             </div>
             <div class="ws-section bg-white p-6 rounded-lg shadow-md md:col-span-1">
                 <h3 class="text-xl font-semibold mb-4">Flash Status Log (WS3)</h3>
                 <pre id="ws3-log" class="w-full h-48 bg-gray-50 border border-gray-200 rounded-md p-2 overflow-y-auto font-mono text-sm"></pre>
             </div>
        `;
        // Attempt to connect immediately after setting up the panel
        connectSocketIO();
    }

    // --- REST API Call ---
    async function sendRestCommand() {
        if (!state.currentDevice || !state.authToken) {
            logTo('rest-log', 'Cannot send command: Not connected or not logged in.');
            return;
        }
        logTo('rest-log', `Sending GET request to https://${state.currentDevice}/cmd/sys/status...`);
        try {
            const response = await fetch(`https://${state.currentDevice}/cmd/sys/status`, {
                headers: { 'Authorization': `Token ${state.authToken}` } // Use 'Token' scheme
            });
            if (!response.ok) {
                 let errorMsg = `API Error: ${response.status} ${response.statusText}`;
                 try {
                     const errData = await response.json();
                     if (errData.detail) errorMsg += ` - ${errData.detail}`;
                 } catch(e) {}
                 throw new Error(errorMsg);
             }
            const data = await response.json();
            logTo('rest-log', `Success:\n${JSON.stringify(data, null, 2)}`);
        } catch (error) {
            console.error("REST Command Error:", error);
            logTo('rest-log', `Error: ${error.message}`);
        }
    }

    // --- Socket.IO Connection Logic ---
    function connectSocketIO() {
        // Prevent multiple connection attempts
        if (state.socket) {
            logTo('ws1-log', 'Socket.IO connection attempt already in progress or connected.');
            return;
        }
        // Ensure prerequisites are met
        if (!state.currentDevice || !state.authToken) {
            logTo('ws1-log', 'Cannot connect Socket.IO: Missing device or auth token.');
            alert('Cannot connect Socket.IO: Missing device or auth token.'); // Alert user
            return;
        }
    
        const url = `wss://${state.currentDevice}`; // Use wss:// for HTTPS Caddy
        logTo('ws1-log', `Attempting Socket.IO connection to ${url}...`);
    
        const socket = io(url, {
            transports: ['websocket'], // Force WebSocket transport
            auth: { token: state.authToken },
            // rejectUnauthorized: false // Keep commented unless absolutely needed for cert issues
        });
    
        // --- Store the socket instance immediately ---
        state.socket = socket;
    
        // --- Centralized Event Listener Setup ---
        // Remove previous listeners (just in case of weird state)
        socket.off('connect');
        socket.off('disconnect');
        socket.off('connect_error');
        socket.off('spget_response');
        socket.off('state_update');
        socket.off('flash_status_update');
    
        // Attach NEW listeners
        socket.on('connect', () => {
            logTo('ws1-log', `Socket.IO connected successfully (SID: ${socket.id}).`);
            // Show command buttons only after successful connection
            const commandDiv = document.getElementById('ws1-commands');
            if (commandDiv) commandDiv.style.display = 'block';
    
            // Emit join room events with callbacks
            socket.emit('join_state_room', {}, (response) => {
                if (response && response.status === 'joined') {
                    logTo('ws2-log', `Successfully joined state room.`);
                } else {
                    logTo('ws2-log', `Failed to join state room: ${JSON.stringify(response)}`);
                }
            });
            socket.emit('join_flash_room', {}, (response) => {
                if (response && response.status === 'joined') {
                    logTo('ws3-log', `Successfully joined flash room.`);
                } else {
                    logTo('ws3-log', `Failed to join flash room: ${JSON.stringify(response)}`);
                }
            });
        });
    
        socket.on('disconnect', (reason) => {
            logTo('ws1-log', `Socket.IO disconnected: ${reason}`);
            // Hide command buttons on disconnect
            const commandDiv = document.getElementById('ws1-commands');
            if (commandDiv) commandDiv.style.display = 'none';
            // Only clear the socket if it's the current one disconnecting
            // Check state.socket exists before comparing id
            if (state.socket && state.socket.id === socket.id) {
                state.socket = null;
            }
        });
    
        socket.on('connect_error', (err) => {
            logTo('ws1-log', `Socket.IO connection error: ${err.message}`);
            console.error("Socket.IO Connection Error:", err);
            // Hide command buttons on connection error
            const commandDiv = document.getElementById('ws1-commands');
            if (commandDiv) commandDiv.style.display = 'none';
             // Check state.socket exists before comparing id
            if (state.socket && state.socket.id === socket.id) {
                state.socket = null; // Clear state if this connection failed
            }
            alert(`Failed to connect Socket.IO: ${err.message}. Check logs.`); // Alert user
        });
    
        // --- Custom Event Listeners ---
        socket.on('spget_response', (data) => {
            // This logs command responses to the WS1 box
            logTo('ws1-log', `Received spget_response: ${JSON.stringify(data)}`);
        });
    
        socket.on('state_update', (data) => {
            // This logs state broadcasts to the WS2 box
            logTo('ws2-log', `Received state_update: ${JSON.stringify(data)}`);
            console.log('Received state_update:', data); // Add console log for debugging
        });
    
        socket.on('flash_status_update', (data) => {
            // This logs flash broadcasts to the WS3 box
            logTo('ws3-log', `Received flash_status_update: ${JSON.stringify(data)}`);
            console.log('Received flash_status_update:', data); // Add console log for debugging
        });
    } // --- End of connectSocketIO function ---

    function disconnectSocketIO() {
        if (state.socket) {
            logTo('ws1-log', 'Disconnecting Socket.IO...');
            state.socket.disconnect();
            // The 'disconnect' event handler above will log and clear state.socket
        } else {
            logTo('ws1-log', 'Socket.IO already disconnected.');
        }
    }

    // --- Socket.IO Command Functions ---
    function ws1_spget() {
        if (state.socket && state.socket.connected) {
            const data = { start: 0, end: 3 }; // Example data payload
            logTo('ws1-log', `Sending event 'spget': ${JSON.stringify(data)}`);
            state.socket.emit('spget', data);
        } else {
            logTo('ws1-log', 'Cannot send spget: Socket.IO not connected.');
        }
    }

    function ws1_spset() {
        if (state.socket && state.socket.connected) {
            const data = { start: 0, end: 3, values: [99, 100] }; // Example data payload
            logTo('ws1-log', `Sending event 'spset': ${JSON.stringify(data)}`);
            // Emit with a callback to handle the server's acknowledgement
            state.socket.emit('spset', data, (response) => {
                logTo('ws1-log', `Received spset acknowledgement: ${JSON.stringify(response)}`);
            });
        } else {
            logTo('ws1-log', 'Cannot send spset: Socket.IO not connected.');
        }
    }

    // --- Known Devices List ---
    function populateDeviceList() {
        const deviceListDiv = document.getElementById('device-list');
        if (!deviceListDiv) return; // Exit if element not found

        if (knownDevices.length === 0) {
            deviceListDiv.innerHTML = '<p class="text-sm text-gray-500">No previously connected devices.</p>';
            return;
        }

        deviceListDiv.innerHTML = '<h4 class="text-lg font-semibold text-custom-dark-grey mb-2">Known Devices:</h4>';
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'flex flex-wrap gap-2';

        knownDevices.forEach(device => {
            const btn = document.createElement('button');
            btn.textContent = device;
            btn.className = 'bg-gray-200 text-custom-dark-grey font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition text-sm';
            btn.onclick = () => {
                const hostnameInput = document.getElementById('device-hostname');
                if (hostnameInput) hostnameInput.value = device;
                connectToDevice();
            };
            buttonContainer.appendChild(btn);
        });
        deviceListDiv.appendChild(buttonContainer);
    }

    // --- Initial Load ---
    window.onload = () => {
        populateDeviceList();
        // Check if there's a device/token from a previous session maybe?
        // (Current logic handles this in connectToDevice based on input/button click)
        console.log("App loaded. Ready to connect.");
    };

</script>
</body>
</html>
