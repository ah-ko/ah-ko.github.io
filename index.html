<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi Web Controller</title>
    <style>
        body { font-family: system-ui, sans-serif; line-height: 1.5; padding: 1rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        input, button, select { font-size: 1rem; padding: 0.5rem; margin: 0.25rem; }
        pre { background-color: #f4f4f4; border: 1px solid #ddd; max-height: 200px; overflow-y: scroll; padding: 5px; white-space: pre-wrap; }
        .ws-section { border: 1px solid #ccc; padding: 10px; margin-top: 1rem; }
    </style>
</head>
<body>

    <h1>Raspberry Pi Web Controller</h1>

    <div id="device-screen" class="screen active">
        <h2>Connect to a Device</h2>
        <p>Enter the local hostname of the Pi (e.g., rsp-one.local).</p>
        <input type="text" id="device-hostname" placeholder="rsp-one.local">
        <button onclick="connectToDevice()">Connect</button>
        <div id="device-list"></div>
    </div>

    <div id="login-screen" class="screen">
        <h2 id="login-header">Login to Device</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
        <button onclick="showScreen('device-screen')">Back to Devices</button>
    </div>

    <div id="control-panel-screen" class="screen">
        <h2 id="control-panel-header">Control Panel</h2>
        <button onclick="disconnectFromDevice()">Disconnect from Device</button>
        
        <div class="ws-section">
            <h3>REST API</h3>
            <button onclick="sendRestCommand()">Get System Status</button>
            <pre id="rest-log"></pre>
        </div>

        <div id="ws-controls"></div>
    </div>

    <script>
        const knownDevices = JSON.parse(localStorage.getItem('knownDevices')) || [];

        // --- Application State ---
        let state = {
            currentScreen: 'device-screen',
            currentDevice: null,
            authToken: null,
            sockets: { ws1: null, ws2: null, ws3: null }
        };

        // --- UI Management ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            state.currentScreen = screenId;
        }

        function logTo(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = `[${new Date().toLocaleTimeString()}] ${message}\n` + el.textContent;
        }

        // --- Device Connection Logic ---
        function connectToDevice() {
            const hostname = document.getElementById('device-hostname').value;
            if (!hostname) { alert('Please enter a hostname.'); return; }
            state.currentDevice = hostname;
            document.getElementById('login-header').textContent = `Login to ${hostname}`;
            showScreen('login-screen');
        }

        function disconnectFromDevice() {
            Object.keys(state.sockets).forEach(key => disconnectWebSocket(key));
            state.currentDevice = null;
            state.authToken = null;
            localStorage.removeItem('authToken');
            showScreen('device-screen');
        }

        // --- Authentication Logic ---
        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch(`https://${state.currentDevice}/api-token-auth/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (!response.ok) throw new Error(`Login failed: ${response.statusText}`);
                const data = await response.json();
                state.authToken = data.token;
                localStorage.setItem(`authToken_${state.currentDevice}`, state.authToken);
                if (!knownDevices.includes(state.currentDevice)) {
                    knownDevices.push(state.currentDevice);
                    localStorage.setItem('knownDevices', JSON.stringify(knownDevices));
                }
                setupControlPanel();
                showScreen('control-panel-screen');
            } catch (error) {
                alert(error.message);
            }
        }

        // --- Control Panel Logic ---
        function setupControlPanel() {
            document.getElementById('control-panel-header').textContent = `Control Panel for ${state.currentDevice}`;
            const wsControls = document.getElementById('ws-controls');
            wsControls.innerHTML = `
                <div class="ws-section">
                    <h3>WS1: Commands</h3>
                    <button onclick="connectWebSocket('ws1', '/ws/commands/')">Open</button>
                    <button onclick="disconnectWebSocket('ws1')">Close</button>
                    <div id="ws1-commands" style="display:none;">
                        <button onclick="ws1_spget()">Send 'spget'</button>
                        <button onclick="ws1_spset()">Send 'spset'</button>
                    </div>
                    <pre id="ws1-log"></pre>
                </div>
                <div class="ws-section">
                    <h3>WS2: State Broadcast</h3>
                    <button onclick="connectWebSocket('ws2', '/ws/state/')">Open</button>
                    <button onclick="disconnectWebSocket('ws2')">Close</button>
                    <pre id="ws2-log"></pre>
                </div>
                <div class="ws-section">
                    <h3>WS3: Flash Status</h3>
                    <button onclick="connectWebSocket('ws3', '/ws/flash/')">Open</button>
                    <button onclick="disconnectWebSocket('ws3')">Close</button>
                    <pre id="ws3-log"></pre>
                </div>
            `;
        }

        async function sendRestCommand() {
            try {
                const response = await fetch(`https://${state.currentDevice}/cmd/sys/status`, {
                    headers: { 'Authorization': `Token ${state.authToken}` }
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();
                logTo('rest-log', JSON.stringify(data));
            } catch (error) {
                logTo('rest-log', error.message);
            }
        }

        function connectWebSocket(socketId, path) {
            if (state.sockets[socketId]) return;
            const url = `wss://${state.currentDevice}${path}?token=${state.authToken}`;
            const socket = new WebSocket(url);
            state.sockets[socketId] = socket;

            socket.onopen = () => {
                logTo(`${socketId}-log`, 'Connection established.');
                if (socketId === 'ws1') document.getElementById('ws1-commands').style.display = 'block';
            };
            socket.onmessage = (event) => logTo(`${socketId}-log`, `Received: ${event.data}`);
            socket.onclose = () => {
                logTo(`${socketId}-log`, 'Connection closed.');
                if (socketId === 'ws1') document.getElementById('ws1-commands').style.display = 'none';
                state.sockets[socketId] = null;
            };
            socket.onerror = (err) => logTo(`${socketId}-log`, 'WebSocket Error.');
        }

        function disconnectWebSocket(socketId) {
            if (state.sockets[socketId]) {
                state.sockets[socketId].close();
            }
        }

        // --- WS1 Command Functions ---
        function ws1_spget() {
            const command = { cmd: "spget", start: 0, end: 3 };
            state.sockets.ws1.send(JSON.stringify(command));
            logTo('ws1-log', `Sent: ${JSON.stringify(command)}`);
        }
        function ws1_spset() {
            const command = { cmd: "spset", start: 0, end: 3, values: [99, 100] };
            state.sockets.ws1.send(JSON.stringify(command));
            logTo('ws1-log', `Sent: ${JSON.stringify(command)}`);
        }

        function populateDeviceList() {
            const deviceListDiv = document.getElementById('device-list');
            deviceListDiv.innerHTML = '<h4>Known Devices:</h4>';
            knownDevices.forEach(device => {
                const btn = document.createElement('button');
                btn.textContent = device;
                btn.onclick = () => {
                    document.getElementById('device-hostname').value = device;
                    connectToDevice();
                };
                deviceListDiv.appendChild(btn);
            });
        }

        window.onload = populateDeviceList;
    </script>
</body>
</html>
