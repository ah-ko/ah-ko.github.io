<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://www.torrentwater.com/wp-content/uploads/2024/10/cropped-TorrentWater_Swirl_200dpi-32x32.png" sizes="32x32">
    <title>Torrent Water Raspi Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 2. Configure Tailwind with your custom color palette
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#3891a1',
                        'custom-dark-grey': '#58595b',
                        'custom-orange': '#f68633',
                        'custom-light-grey': '#b1b3b6',
                        'custom-canada-red': '#EF3340',
                    }
                }
            }
        }
    </script>
    <style>
        /* Keep the multi-screen logic */
        .screen { display: none; }
        .screen.active { display: block; }
    </style>
</head>

<body class="bg-gray-100 text-custom-dark-grey font-sans">

    <header class="bg-custom-dark-grey text-white shadow-md">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-2xl font-bold">Raspberry Pi Web Controller</h1>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">

        <div id="device-screen" class="screen active">
            <div class="max-w-xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Connect to a Device</h2>
                <p class="text-gray-600 mb-6">Enter the local hostname of the Pi (e.g., rsp-one.local).</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="device-hostname" placeholder="rsp-one.local" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue">
                    <button onclick="connectToDevice()" class="bg-custom-blue text-white font-bold py-2 px-6 rounded-md hover:bg-opacity-80 transition duration-300">Connect</button>
                </div>
                <div id="device-list" class="mt-8">
                    </div>
            </div>
        </div>

        <div id="login-screen" class="screen">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h2 id="login-header" class="text-2xl font-semibold mb-6 text-center">Login to Device</h2>
                <div class="space-y-4">
                    <input type="text" id="username" placeholder="Username" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue">
                    <input type="password" id="password" placeholder="Password" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-custom-blue">
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-2">
                    <button onclick="handleLogin()" class="w-full bg-custom-blue text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Login</button>
                    <button onclick="showScreen('device-screen')" class="w-full bg-custom-light-grey text-custom-dark-grey font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Back</button>
                </div>
            </div>
        </div>

        <div id="control-panel-screen" class="screen">
            <div class="flex justify-between items-center mb-6">
                <h2 id="control-panel-header" class="text-3xl font-bold">Control Panel</h2>
                <button onclick="disconnectFromDevice()" class="bg-custom-canada-red text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Disconnect</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">REST API</h3>
                    <button onclick="sendRestCommand()" class="bg-custom-blue text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300 mb-4">Get System Status</button>
                    <pre id="rest-log" class="w-full h-32 bg-gray-50 border border-gray-200 rounded-md p-2 overflow-y-auto font-mono text-sm"></pre>
                </div>

                <div id="ws-controls" class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>
        </div>
    </main>

    <script>
        // --- YOUR EXISTING JAVASCRIPT LOGIC (Unchanged) ---
        const knownDevices = JSON.parse(localStorage.getItem('knownDevices')) || [];

        // --- Application State ---
        let state = {
            currentScreen: 'device-screen',
            currentDevice: null,
            authToken: null,
            sockets: { ws1: null, ws2: null, ws3: null }
        };

        // --- UI Management ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            state.currentScreen = screenId;
        }

        function logTo(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = `[${new Date().toLocaleTimeString()}] ${message}\n` + el.textContent;
        }

        // --- Device Connection Logic ---
        function connectToDevice() {
            const hostname = document.getElementById('device-hostname').value;
            if (!hostname) { alert('Please enter a hostname.'); return; }
            state.currentDevice = hostname;
            document.getElementById('login-header').textContent = `Login to ${hostname}`;
            showScreen('login-screen');
        }

        function disconnectFromDevice() {
            Object.keys(state.sockets).forEach(key => disconnectWebSocket(key));
            state.currentDevice = null;
            state.authToken = null;
            localStorage.removeItem('authToken');
            showScreen('device-screen');
        }

        // --- Authentication Logic ---
        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch(`https://${state.currentDevice}/api-token-auth/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (!response.ok) throw new Error(`Login failed: ${response.statusText}`);
                const data = await response.json();
                state.authToken = data.token;
                localStorage.setItem(`authToken_${state.currentDevice}`, state.authToken);
                if (!knownDevices.includes(state.currentDevice)) {
                    knownDevices.push(state.currentDevice);
                    localStorage.setItem('knownDevices', JSON.stringify(knownDevices));
                }
                setupControlPanel();
                showScreen('control-panel-screen');
            } catch (error) {
                alert(error.message);
            }
        }

        // --- Control Panel Logic ---
        function setupControlPanel() {
            document.getElementById('control-panel-header').textContent = `Control Panel for ${state.currentDevice}`;
            const wsControls = document.getElementById('ws-controls');
            // Styled with Tailwind classes
            wsControls.innerHTML = `
                <div class="ws-section bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">WS1: Commands</h3>
                    <div class="flex gap-2 mb-4">
                        <button onclick="connectWebSocket('ws1', '/ws/commands/')" class="flex-1 bg-custom-blue text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Open</button>
                        <button onclick="disconnectWebSocket('ws1')" class="flex-1 bg-custom-light-grey text-custom-dark-grey font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Close</button>
                    </div>
                    <div id="ws1-commands" style="display:none;" class="space-y-2 mb-4">
                        <button onclick="ws1_spget()" class="w-full bg-gray-200 text-custom-dark-grey font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition">Send 'spget'</button>
                        <button onclick="ws1_spset()" class="w-full bg-gray-200 text-custom-dark-grey font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition">Send 'spset'</button>
                    </div>
                    <pre id="ws1-log" class="w-full h-32 bg-gray-50 border border-gray-200 rounded-md p-2 overflow-y-auto font-mono text-sm"></pre>
                </div>
                <div class="ws-section bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">WS2: State Broadcast</h3>
                    <div class="flex gap-2 mb-4">
                        <button onclick="connectWebSocket('ws2', '/ws/state/')" class="flex-1 bg-custom-blue text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Open</button>
                        <button onclick="disconnectWebSocket('ws2')" class="flex-1 bg-custom-light-grey text-custom-dark-grey font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Close</button>
                    </div>
                    <pre id="ws2-log" class="w-full h-32 bg-gray-50 border border-gray-200 rounded-md p-2 overflow-y-auto font-mono text-sm"></pre>
                </div>
                <div class="ws-section bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">WS3: Flash Status</h3>
                    <div class="flex gap-2 mb-4">
                        <button onclick="connectWebSocket('ws3', '/ws/flash/')" class="flex-1 bg-custom-orange text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Open</button>
                        <button onclick="disconnectWebSocket('ws3')" class="flex-1 bg-custom-light-grey text-custom-dark-grey font-bold py-2 px-4 rounded-md hover:bg-opacity-80 transition duration-300">Close</button>
                    </div>
                    <pre id="ws3-log" class="w-full h-32 bg-gray-50 border border-gray-200 rounded-md p-2 overflow-y-auto font-mono text-sm"></pre>
                </div>
            `;
        }

        async function sendRestCommand() {
            try {
                const response = await fetch(`https://${state.currentDevice}/cmd/sys/status`, {
                    headers: { 'Authorization': `Token ${state.authToken}` }
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();
                logTo('rest-log', JSON.stringify(data, null, 2));
            } catch (error) {
                logTo('rest-log', error.message);
            }
        }

        function connectWebSocket(socketId, path) {
            if (state.sockets[socketId]) return;
            const url = `wss://${state.currentDevice}${path}?token=${state.authToken}`;
            const socket = new WebSocket(url);
            state.sockets[socketId] = socket;

            socket.onopen = () => {
                logTo(`${socketId}-log`, 'Connection established.');
                if (socketId === 'ws1') document.getElementById('ws1-commands').style.display = 'block';
            };
            socket.onmessage = (event) => logTo(`${socketId}-log`, `Received: ${event.data}`);
            socket.onclose = () => {
                logTo(`${socketId}-log`, 'Connection closed.');
                if (socketId === 'ws1') document.getElementById('ws1-commands').style.display = 'none';
                state.sockets[socketId] = null;
            };
            socket.onerror = (err) => logTo(`${socketId}-log`, 'WebSocket Error.');
        }

        function disconnectWebSocket(socketId) {
            if (state.sockets[socketId]) {
                state.sockets[socketId].close();
            }
        }

        // --- WS1 Command Functions ---
        function ws1_spget() {
            const command = { cmd: "spget", start: 0, end: 3 };
            state.sockets.ws1.send(JSON.stringify(command));
            logTo('ws1-log', `Sent: ${JSON.stringify(command)}`);
        }
        function ws1_spset() {
            const command = { cmd: "spset", start: 0, end: 3, values: [99, 100] };
            state.sockets.ws1.send(JSON.stringify(command));
            logTo('ws1-log', `Sent: ${JSON.stringify(command)}`);
        }

        function populateDeviceList() {
            const deviceListDiv = document.getElementById('device-list');
            if (knownDevices.length === 0) {
                deviceListDiv.innerHTML = ''; // No header if no devices
                return;
            }
            deviceListDiv.innerHTML = '<h4 class="text-lg font-semibold text-custom-dark-grey mb-2">Known Devices:</h4>';
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex flex-wrap gap-2';
            knownDevices.forEach(device => {
                const btn = document.createElement('button');
                btn.textContent = device;
                btn.className = 'bg-gray-200 text-custom-dark-grey font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition';
                btn.onclick = () => {
                    document.getElementById('device-hostname').value = device;
                    connectToDevice();
                };
                buttonContainer.appendChild(btn);
            });
            deviceListDiv.appendChild(buttonContainer);
        }

        window.onload = populateDeviceList;
    </script>
</body>
</html>
